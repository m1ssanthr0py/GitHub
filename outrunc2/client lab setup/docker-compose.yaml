services:
  endpoint1:
    image: alpine:latest
    container_name: linux_endpoint1
    volumes:
      - ./auto-client.sh:/usr/local/bin/auto-client.sh:ro
    command: ["/usr/local/bin/auto-client.sh"]
    environment:
      - C2_HOST=192.168.210.170
      - C2_PORT=8080
    stdin_open: true
    tty: true
    networks:
      lab_network:
        ipv4_address: 192.168.210.10
    hostname: endpoint1
    depends_on:
      webserver:
        condition: service_healthy
    restart: unless-stopped

  endpoint2:
    image: alpine:latest
    container_name: linux_endpoint2
    volumes:
      - ./auto-client.sh:/usr/local/bin/auto-client.sh:ro
    command: ["/usr/local/bin/auto-client.sh"]
    environment:
      - C2_HOST=192.168.210.170
      - C2_PORT=8080
    stdin_open: true
    tty: true
    networks:
      lab_network:
        ipv4_address: 192.168.210.11
    hostname: endpoint2
    depends_on:
      webserver:
        condition: service_healthy
    restart: unless-stopped

  endpoint3:
    image: alpine:latest
    container_name: linux_endpoint3
    volumes:
      - ./auto-client.sh:/usr/local/bin/auto-client.sh:ro
    command: ["/usr/local/bin/auto-client.sh"]
    environment:
      - C2_HOST=192.168.210.170
      - C2_PORT=8080
    stdin_open: true
    tty: true
    networks:
      lab_network:
        ipv4_address: 192.168.210.12
    hostname: endpoint3
    depends_on:
      webserver:
        condition: service_healthy
    restart: unless-stopped

  webserver:
    build:
      context: ../webserver
      dockerfile: Dockerfile
    container_name: outrun_webserver
    ports:
      - "8080:8080"    # Web interface
      - "8888:8888"    # C2 server
      - "8889:8889"    # C2 management console
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    cap_add:
      - NET_RAW
    networks:
      lab_network:
        ipv4_address: 192.168.210.170
    hostname: outrun-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  lab_network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.210.0/24
          gateway: 192.168.210.1
